{% extends "base.html" %}

{% block title %}éŸ³é¢‘è¯†åˆ« - PUBGæ­¦å™¨ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="audio-recognition-page">
    <h2>ğŸµ æ­¦å™¨å£°éŸ³è¯†åˆ«</h2>
    <p class="subtitle">{{ model_info }}</p>
    {% if model_status %}
        {% if model_loaded %}
        <div class="notice notice-success">{{ model_status }}</div>
        {% else %}
        <div class="notice notice-warn">{{ model_status }}</div>
        {% endif %}
    {% endif %}

    <!-- ä¸Šä¼ åŒºåŸŸ -->
    <div class="upload-section">
        <div class="upload-box" id="uploadBox">
            <div class="upload-icon">ğŸ“</div>
            <h3>ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶</h3>
            <p>æ”¯æŒ MP3, WAV, FLAC æ ¼å¼</p>
            <input type="file" id="audioFile" accept=".mp3,.wav,.flac" style="display: none;">
            <button onclick="document.getElementById('audioFile').click()" class="btn btn-primary">
                é€‰æ‹©æ–‡ä»¶
            </button>
        </div>

        <div id="selectedFile" class="selected-file" style="display: none;">
            <div class="file-info">
                <span class="file-icon">ğŸµ</span>
                <span id="fileName"></span>
            </div>
            <button onclick="uploadAudio()" class="btn btn-success" id="recognizeBtn">
                ğŸ¤– å¼€å§‹è¯†åˆ«
            </button>
        </div>
    </div>

    <!-- è¯†åˆ«ç»“æœ -->
    <div id="resultSection" class="result-section" style="display: none;">
        <h3>è¯†åˆ«ç»“æœ</h3>
        <div id="resultCard" class="result-card">
            <!-- ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
    </div>

    <!-- æ¼”ç¤ºéŸ³é¢‘ -->
    <div class="demo-section">
        <h3>ğŸ¯ æ¼”ç¤ºéŸ³é¢‘</h3>
        <p>å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ¼”ç¤ºéŸ³é¢‘è¿›è¡Œæµ‹è¯•:</p>
        <div class="demo-grid">
            <div class="demo-item">
                <span>ğŸ”« AKM</span>
                <code>demo/ak_demo.mp3</code>
            </div>
            <div class="demo-item">
                <span>ğŸ”« M416</span>
                <code>demo/m4_demo.mp3</code>
            </div>
            <div class="demo-item">
                <span>ğŸ”« AWM</span>
                <code>demo/awm_demo.mp3</code>
            </div>
            <div class="demo-item">
                <span>ğŸ”« SKS</span>
                <code>demo/sks_demo.mp3</code>
            </div>
            <div class="demo-item">
                <span>ğŸ”« UMP9</span>
                <code>demo/ump_demo.mp3</code>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const MODEL_LOADED = {{ 'true' if model_loaded else 'false' }};

// æ–‡ä»¶é€‰æ‹©
document.getElementById('audioFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('selectedFile').style.display = 'flex';
        document.getElementById('resultSection').style.display = 'none';
    }
});

// ä¸Šä¼ è¯†åˆ«
function uploadAudio() {
    if (!MODEL_LOADED) {
        showResult('error', 'éŸ³é¢‘è¯†åˆ«æ¨¡å‹æœªå°±ç»ªï¼Œæ— æ³•è¯†åˆ«ã€‚');
        return;
    }

    const fileInput = document.getElementById('audioFile');
    const file = fileInput.files[0];

    if (!file) {
        alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
        return;
    }

    const formData = new FormData();
    formData.append('audio_file', file);

    const recognizeBtn = document.getElementById('recognizeBtn');
    recognizeBtn.disabled = true;
    recognizeBtn.textContent = 'ğŸ”„ è¯†åˆ«ä¸­...';

    const csrfTokenMeta = document.querySelector('meta[name="csrf-token"]');
    const csrfToken = csrfTokenMeta ? csrfTokenMeta.getAttribute('content') : '';

    fetch('/upload_audio', {
        method: 'POST',
        headers: csrfToken ? { 'X-CSRFToken': csrfToken } : {},
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showResult('error', data.error);
        } else {
            showResult('success', data.weapon, data.confidence);
        }
    })
    .catch(error => {
        showResult('error', 'è¯†åˆ«å¤±è´¥: ' + error);
    })
    .finally(() => {
        recognizeBtn.disabled = false;
        recognizeBtn.textContent = 'ğŸ¤– å¼€å§‹è¯†åˆ«';
    });
}

// æ˜¾ç¤ºç»“æœ
function showResult(type, weapon, confidence) {
    const resultSection = document.getElementById('resultSection');
    const resultCard = document.getElementById('resultCard');

    resultSection.style.display = 'block';

    if (type === 'success') {
        resultCard.innerHTML = `
            <div class="result-success">
                <div class="result-icon">âœ…</div>
                <h2>${weapon}</h2>
                <p class="confidence">ç½®ä¿¡åº¦: ${confidence}</p>
            </div>
        `;
    } else {
        resultCard.innerHTML = `
            <div class="result-error">
                <div class="result-icon">âŒ</div>
                <h3>è¯†åˆ«å¤±è´¥</h3>
                <p>${weapon}</p>
            </div>
        `;
    }

    // æ»šåŠ¨åˆ°ç»“æœ
    resultSection.scrollIntoView({ behavior: 'smooth' });
}
</script>
{% endblock %}
